---
title: "Population and Lyme Disease Prevalence of Maine Cities"
output: 
  html_document:
     toc: TRUE
     number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

# Load Packages

```{r libraries, echo = FALSE}

library(tidyverse) 
library(leaflet) 
library(sf) 
library(RColorBrewer) 
library(htmltools) 
library(leafsync) 
library(kableExtra) 
library(tidycensus)
library(rvest)
library(DT)
library(fedmatch)

```

# Import and Clean Data

```{r data-import, echo = FALSE}

# read csv files
tick_towns <- read_csv("/cloud/project/data/ticks/tickborne_prevalence_town.csv")

# apply census api key
census_api_key("5177724b01a7fe4714097e711cb95230c37cfce7", install = TRUE, overwrite = TRUE)

# import census data
census_place_df <- get_acs(geography = "place", variables = c("B01003_001E"), state = "ME", geometry = TRUE)
census_county_sub_df <- get_acs(geography = "county subdivision", variables = c("B01003_001E"), state = "ME", geometry = TRUE)

```


```{r reformat-location-variables}

# reformat location variables >> census place df
census_place_df <- census_place_df %>%
  separate(NAME, into = c("Place", "State"), sep = ",") %>%
  mutate(Place = str_remove(Place, " CDP| city"))

# reformat location variables >> census county subdivision df
census_county_sub_df <- census_county_sub_df %>%
  separate(NAME, into = c("Place", "County", "State"), sep = ",") %>%
  mutate(Place = str_remove(Place, "town| city")) %>%
  mutate(Place = str_replace(Place, "UT", "Twp")) %>%
  mutate(Place = str_replace(Place, "plantation", "Plantation")) %>%
  mutate(Place = str_replace(Place, "George town", "Georgetown")) %>%
  mutate(Place = str_replace(Place, "Hibberts gore", "Hibberts Gore")) %>%
  mutate(Place = str_trim(Place, side = "both"))

# reformat location variables >> tick towns df
tick_towns <- tick_towns %>%
  mutate(town = str_replace(town, "plt", "Plantation")) %>%
  mutate(town = str_replace(town, "Plt", "Plantation")) %>%
  mutate(town = str_replace(town, "Monhegan Island", "Monhegan")) %>%
  mutate(town = str_replace(town, "Muscle Ridge", "Muscle Ridge Islands")) %>%
  mutate(town = str_replace(town, "Cary Twp", "Cary Plantation")) %>%
  mutate(town = str_replace(town, "Codyville Twp", "Codyville Plantation")) %>%
  mutate(town = str_replace(town, "Seboomook Twp", "Seboomook Lake Twp")) %>%
  mutate(town = str_replace(town, "Prentiss Twp T4 R4 NBKP", "Prentiss Twp")) %>%
  mutate(town = str_replace(town, "Dennistown", "Dennis")) %>%
  mutate(town = str_replace(town, "Saint", "St.")) %>%
  mutate(town = str_replace(town, "Atkinson Twp", "Atkinson")) %>%
  mutate(town = str_replace(town, "Bancroft Twp", "Bancroft")) 
```


```{r visualize-population-data}

# visualize polygons using ggplot
ggplot(census_place_df) +
    geom_sf(aes(fill = estimate))

# visualize polygons using ggplot
ggplot(census_county_sub_df) +
    geom_sf(aes(fill = estimate))

```

```{r organize-data}

# set CRS
census_place_df <- st_transform(census_place_df, "+init=epsg:4326")
census_county_sub_df <- st_transform(census_county_sub_df, "+init=epsg:4326")

# join tick data with census data >> census place df with tick towns df
tick_census_place_df <- tick_towns %>%
  left_join(census_place_df, by = c("town" = "Place"))

# join tick data with census data >> census county subdivision df with tick towns df
tick_census_county_sub_df <- tick_towns %>%
  left_join(census_county_sub_df, by = c("town" = "Place"))

missing <- anti_join(census_county_sub_df, tick_towns, by = c("Place" = "town")) %>%
                    select(Place, County)

```

```{r tick-and-population-leaflet}

# create labels
pop_labels <- sprintf(
  "<strong>%s (2019)</strong> <br/>Population: %g",
   census_df$Place, census_df$estimate
) %>% lapply(htmltools::HTML)

tick_labels <- sprintf(
  "<strong>%s (2019)</strong> <br/>Positive Lyme Tests: %g, <br/> Positivity Rate: %s",
  tick_towns$town, tick_towns$borrelia_positive, tick_towns$borrelia_percent
) %>% lapply(htmltools::HTML)

# create layer names
Groupnames <- c("Population", "Positive Lyme Tests")

# define bins
bins1 <- seq(0, 80000, by = 10000)
bins2 <- seq(0, 30, by = 3)

# select color palettes
pal1 <- colorBin("OrRd", domain = census_df$estimate, bins = bins)
pal2 <- colorBin("PuRd", domain = tick_towns$borrelia_positive, bins = bins2)

# generate leaflet
leaflet(census_df) %>%
  addProviderTiles(providers$Stamen.Terrain) %>%
  addProviderTiles(providers$Stamen.TerrainLabels) %>%
  addPolygons(fillColor = ~pal1(census_df$estimate),
              color = "black",
              weight = 1,
              fillOpacity = 0.9,
              label = ~pop_labels,
              group = "Population") %>%
  addPolygons(fillColor = ~pal2(tick_towns$borrelia_positive),
              color = "black",
              weight = 1,
              fillOpacity = 0.9,
              label = ~tick_labels,
              group = "Positive Lyme Tests") %>%
  setView(lng = -69.5, 
          lat = 45.3, 
          zoom = 6.5) %>%
   addLayersControl(
     baseGroups = Groupnames,
     options = layersControlOptions(collapsed = FALSE)
  ) 

```


```{r tick-towns-missing-from-census-data, echo = FALSE}

missing_ticktown <- anti_join(tick_towns, census_df, by = c("town" = "Place")) %>%
                    select(town, borrelia_positive, borrelia_tests)

DT::datatable(missing_ticktown,
              options = list(
                paging = TRUE,
                pageLength = 10),
              height = 500)
              
```


```{r census-towns-missing-from-tick-data, echo = FALSE}

missing_censustown <- anti_join(census_df, tick_towns, by = c("Place" = "town")) %>%
                      select(Place, estimate, moe)

DT::datatable(missing_censustown,
              options = list(
                paging = TRUE,
                pageLength = 10),
              height = 500)
              
```

```{r fuzzy-match, echo = FALSE}

tick_towns$row_num <- seq.int(nrow(tick_towns)) 

fuzzy_result <- merge_plus(data1 = census_df, data2 = tick_towns,
                           by.x = "Place", by.y = "town",
                           match_type = "fuzzy",
                           fuzzy_settings = build_fuzzy_settings(
                             p = 0.1,
                             maxDist = 0.15),
                           unique_key_1 = "GEOID", unique_key_2 = "row_num")

DT::datatable(fuzzy_result[[1]],
              options = list(
                paging = TRUE,
                pageLength = 10),
              height = 500)
              
```
