---
title: "Population and Age of Maine Cities"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Packages

```{r libraries, echo = FALSE}

library(tidyverse) 
library(leaflet) 
library(sf) 
library(RColorBrewer) 
library(htmltools) 
library(leafsync) 
library(kableExtra) 
library(tidycensus)
library(rvest)
library(DT)
library(fedmatch)


```

# Import and Clean Data

```{r data-import, echo = FALSE}

# read shape files
me_cities <- st_read("data/demographics/spatial/cities/tl_2016_23_place.shp")
me_counties <- st_read("data/demographics/spatial/counties/Maine_County_Boundary_Polygons_Feature.shp")

# read csv files
me_pop <- read_csv("data/demographics/maine_city_population.csv")
tick_towns <- read_csv("/cloud/project/data/ticks/tickborne_prevalence_town.csv")

me_spatial <- me_cities %>%
  left_join(me_pop, by= "NAME")



```

```{r change-coordinate-reference-system, echo = FALSE}

# change CRS
me_cities <- st_transform(me_cities, "+init=epsg:4326")
me_counties <- st_transform(me_counties, "+init=epsg:4326")

me_spatial <- st_transform(me_spatial, "+init=epsg:4326")

# report new CRS
st_crs(me_cities)
st_crs(me_counties)
```

# Generate Cities Leaflet

```{r generate-cities-leaflet-basemap, echo = FALSE}

# set view and add texture
me_cities_bm <- leaflet(data = me_cities) %>% #<<
  addProviderTiles(providers$Stamen.Terrain) %>%
  setView(lng = -69.5, 
          lat = 45.3, 
          zoom = 6.5)

# add city borders
me_cities_bm %>%
  addPolygons(
    opacity = 1,
    color = "blue", 
    weight = 2) 
```

```{r generate-cities-leaflet-labels, echo = FALSE}

# create labels
me_cities_labels <- sprintf("<strong>%s</strong><br/>geoid # %s ", 
                  me_cities$NAME, me_cities$GEOID) %>% lapply(htmltools::HTML)

```


```{r first-cities-leaflet-map, eval=TRUE}
me_cities_map <- me_cities_bm %>%
  addPolygons(
      color = "blue", 
      opacity = 1,
      weight = 2,
    highlight = highlightOptions( #<<
        weight = 3, #<<
        color = "green", #<<
        fillOpacity = 1, #<<
        bringToFront = TRUE)) #<< 

me_cities_map
```

 
# Generate Counties Leaflet

```{r generate-counties-leaflet-basemap, echo = FALSE}

# set view and add texture
me_counties_bm <- leaflet(data = me_counties) %>% #<<
  addProviderTiles(providers$Stamen.Terrain) %>%
  setView(lng = -69.5, 
          lat = 45.3, 
          zoom = 6.5)

# add city borders
me_counties_bm %>%
  addPolygons(
    opacity = 1,
    color = "blue", 
    weight = 2) 
```

```{r generate-counties-leaflet-labels, echo = FALSE}

# create labels
me_counties_labels <- sprintf("<strong>%s</strong><br/>objectid # %s ", 
                  me_counties$NAME, me_counties$OBJECTID) %>% lapply(htmltools::HTML)

```


```{r first-counties-leaflet-map, eval=TRUE}
me_counties_map <- me_counties_bm %>%
  addPolygons(
      color = "blue", 
      opacity = 1,
      weight = 2,
    highlight = highlightOptions( #<<
        weight = 3, #<<
        color = "green", #<<
        fillOpacity = 1, #<<
        bringToFront = TRUE)) #<< 

me_counties_map
```

## Census Data

## Census Variables

```{r census-data}

census_api_key("5177724b01a7fe4714097e711cb95230c37cfce7", install = TRUE, overwrite = TRUE)

```


```{r}

census_df <- get_acs(geography = "place", variables = c("B01003_001E"), state = "ME", geometry = TRUE)

census_df <- census_df %>%
  separate(NAME, into = c("Place", "State"), sep = ",") %>%
  mutate(Place = str_remove(Place, " CDP| city"))


  
ggplot(census_df) +
    geom_sf(aes(fill = estimate))

```

```{r}

census_df <- st_transform(census_df, "+init=epsg:4326")

tick_census_df <- tick_towns %>%
  left_join(census_df, by = c("town" = "Place"))

anti_join(tick_towns, census_df, by = c("town" = "Place"))

mismatches <- anti_join(census_df, tick_towns, by = c("Place" = "town"))

pop_age_labels <- sprintf(
  "<strong>%s (2019)</strong> <br/>Population: %g",
   census_df$Place, census_df$estimate
) %>% lapply(htmltools::HTML)

bins <- seq(0, 80000, by = 10000)
pal <- colorBin("OrRd", domain = census_df$estimate, bins = bins)
leaflet(census_df) %>%
  addProviderTiles(providers$Stamen.Terrain) %>%
  addProviderTiles(providers$Stamen.TerrainLabels) %>%
  addPolygons(fillColor = ~pal(census_df$estimate),
              color = "black",
              weight = 1,
              fillOpacity = 0.9,
              label = ~pop_age_labels)

```


```{r tick-towns-missing-from-census-data, echo = FALSE}

missing_ticktown <- anti_join(tick_towns, census_df, by = c("town" = "Place")) %>%
                    select(town, borrelia_positive, borrelia_tests)

DT::datatable(missing_ticktown,
              options = list(
                paging = TRUE,
                pageLength = 10),
              height = 500)
              
```


```{r census-towns-missing-from-tick-data, echo = FALSE}

missing_censustown <- anti_join(census_df, tick_towns, by = c("Place" = "town")) %>%
                      select(Place, estimate, moe)

DT::datatable(missing_censustown,
              options = list(
                paging = TRUE,
                pageLength = 10),
              height = 500)
              
```

```{r fuzzy-match, echo = FALSE}

tick_towns$row_num <- seq.int(nrow(tick_towns)) 

fuzzy_result <- merge_plus(data1 = census_df, data2 = tick_towns,
                           by.x = "Place", by.y = "town",
                           match_type = "fuzzy",
                           fuzzy_settings = build_fuzzy_settings(
                             p = 0.1,
                             maxDist = 0.15),
                           unique_key_1 = "GEOID", unique_key_2 = "row_num")

DT::datatable(fuzzy_result[[1]],
              options = list(
                paging = TRUE,
                pageLength = 10),
              height = 500)
              
```
